<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–∏–≤—ã—á–∫–∏</title>
  <link rel="stylesheet" href="common.css?v=17">
    <link rel="stylesheet" href="header.css">        <!-- ‚Üê –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£ -->
  <link rel="stylesheet" href="habits.css">
  <script src="header-loader.js"></script>
  <script src="auth.js"></script>

</head>

<body class="theme-storm">
  <div class="site-bg-base"></div>
  <div class="site-bg-mask"></div>

  <div class="app-root">
    <div class="app-shell">

<!-- –ó–∞–≥—Ä—É–∂–∞–µ–º–∞—è –æ–±—â–∞—è —à–∞–ø–∫–∞ -->
<div id="header-placeholder"></div>


      <main class="page-content page-habits" id="habits">
        <div class="page-inner">
          <div class="page-header">
            <h1 class="page-title">üìà –ü—Ä–∏–≤—ã—á–∫–∏</h1>
          </div>

          <section class="block block-life-time">
            <h2 class="block-title">‚è≥ –ñ–∏–∑–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è</h2>
            <div class="life-time-grid">
              <div class="life-time-item">
                <div class="life-time-item__label">–ü—Ä–æ–∂–∏—Ç–æ</div>
                <div class="life-time-item__value" id="lifePercent">0%</div>
                <div class="life-time-item__bar">
                  <div class="life-time-item__bar-fill" id="lifeProgressBar" style="width:0%">
                    <span id="lifeProgressText" style="display:inline-block;padding:0 6px;font-size:11px;font-weight:600;color:#020617;">0%</span>
                  </div>
                </div>
                <div class="life-time-item__details" id="lifeDetails" style="font-size:12px;margin-top:4px;opacity:.8">0 –ª–µ—Ç, 100% –æ—Å—Ç–∞–ª–æ—Å—å</div>
              </div>

              <div class="life-time-item">
                <div class="life-time-item__label">–õ–∏—á–Ω—ã–π –≥–æ–¥</div>
                <div class="life-time-item__value" id="yearDays">0</div>
                <div class="life-time-item__bar personal-year-bar">
                  <div class="life-time-item__bar-fill personal-year-bar__fill" id="yearProgressBar" style="width:0%">
                    <span id="yearProgressText" style="display:inline-block;padding:0 6px;font-size:11px;font-weight:600;color:#020617;">0%</span>
                  </div>
                </div>
                <div class="life-time-item__details" id="yearDetails" style="font-size:12px;margin-top:4px;opacity:.8">0 –¥–Ω–µ–π –ø—Ä–æ–∂–∏—Ç–æ, 0 –¥–æ –î–†</div>
              </div>
            </div>
          </section>

          <section class="block block-habits-table">
            <div class="block-header">
              <h2 class="block-title">–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫</h2>
              <div class="block-header__controls">
                <div class="habits-month-select-wrapper">
                  <button type="button" class="habits-month-select" id="habits-month-button">01.2026</button>
                  <div class="habits-month-dropdown" id="habits-month-dropdown" hidden></div>
                </div>
                <button type="button" class="habits-btn" id="habits-new-month-btn">+ –ù–æ–≤—ã–π –º–µ—Å—è—Ü</button>
                <button type="button" class="habits-btn habits-btn--danger" id="habits-delete-month-btn">–£–¥–∞–ª–∏—Ç—å –º–µ—Å—è—Ü</button>
                <button type="button" class="habits-btn habits-btn--tutorial" onclick="restartTour()" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ"> üìñ </button>
                <div class="habits-help-tooltip" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ç–∞–±–ª–∏—Ü–µ–π">
                  <span class="habits-help-tooltip__icon">?</span>
                  <div class="habits-help-tooltip__content">
                    <p><strong>–î–Ω–∏ - –õ–ö–ú:</strong> –°—Ç–∞–≤–∏—Ç/—Å–Ω–∏–º–∞–µ—Ç ‚úì</p>
                    <p><strong>–ß–∞—Å—ã - –õ–ö–ú:</strong> –ó–∞–ø—É—Å–∫/—Å—Ç–æ–ø —Ç–∞–π–º–µ—Ä–∞ (–±–µ–∑ –≤–≤–æ–¥–∞ 1)</p>
                    <p><strong>–ß–∞—Å—ã - –ü–ö–ú:</strong> +1 —á–∞—Å</p>
                    <p><strong>–ß–∞—Å—ã - –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫:</strong> ‚àí1 —á–∞—Å (–¥–æ 0)</p>
                    <p><strong>–°—á—ë—Ç–∞ - –õ–ö–ú:</strong> +1</p>
                    <p><strong>–°—á—ë—Ç–∞ - –ü–ö–ú:</strong> ‚àí1 (–¥–æ 0)</p>
                    <p><strong>–ü–ö–ú –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é / –µ–¥. –∏–∑–º. / –ø–ª–∞–Ω—É:</strong> –º–µ–Ω—é —Å—Ç—Ä–æ–∫–∏</p>
                  </div>
                </div>
              </div>
            </div>

            <div id="habit-row-menu" class="habit-row-menu" hidden>
              <div class="habit-row-menu__item" data-action="edit">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
              <div class="habit-row-menu__item" data-action="move">‚ü∑ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫—É</div>
              <div class="habit-row-menu__item habit-row-menu__item--delete" data-action="delete">‚úï –£–¥–∞–ª–∏—Ç—å</div>
            </div>

            <div class="table-wrapper table-wrapper--scroll">
              <table class="habits-table" id="habits-table">
                <thead>
                  <tr>
                    <th class="col-task sticky sticky-col-1" rowspan="2">–ó–∞–¥–∞—á–∞</th>
                    <th class="col-unit sticky sticky-col-2" rowspan="2">–ï–¥. –∏–∑–º.</th>
                    <th class="col-plan sticky sticky-col-3" rowspan="2">–ü–ª–∞–Ω</th>
                    <th class="col-day" data-day="1">1</th><th class="col-day" data-day="2">2</th>
                    <th class="col-day" data-day="3">3</th><th class="col-day" data-day="4">4</th>
                    <th class="col-day" data-day="5">5</th><th class="col-day" data-day="6">6</th>
                    <th class="col-day" data-day="7">7</th><th class="col-day" data-day="8">8</th>
                    <th class="col-day" data-day="9">9</th><th class="col-day" data-day="10">10</th>
                    <th class="col-day" data-day="11">11</th><th class="col-day" data-day="12">12</th>
                    <th class="col-day" data-day="13">13</th><th class="col-day" data-day="14">14</th>
                    <th class="col-day" data-day="15">15</th><th class="col-day" data-day="16">16</th>
                    <th class="col-day" data-day="17">17</th><th class="col-day" data-day="18">18</th>
                    <th class="col-day" data-day="19">19</th><th class="col-day" data-day="20">20</th>
                    <th class="col-day" data-day="21">21</th><th class="col-day" data-day="22">22</th>
                    <th class="col-day" data-day="23">23</th><th class="col-day" data-day="24">24</th>
                    <th class="col-day" data-day="25">25</th><th class="col-day" data-day="26">26</th>
                    <th class="col-day" data-day="27">27</th><th class="col-day" data-day="28">28</th>
                    <th class="col-day" data-day="29">29</th><th class="col-day" data-day="30">30</th>
                    <th class="col-day" data-day="31">31</th>
                    <th class="col-result" rowspan="2">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    <th class="col-percent" rowspan="2">% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</th>
                  </tr>
                  <tr>
                    <th class="col-day col-day-week" data-day="1"></th><th class="col-day col-day-week" data-day="2"></th>
                    <th class="col-day col-day-week" data-day="3"></th><th class="col-day col-day-week" data-day="4"></th>
                    <th class="col-day col-day-week" data-day="5"></th><th class="col-day col-day-week" data-day="6"></th>
                    <th class="col-day col-day-week" data-day="7"></th><th class="col-day col-day-week" data-day="8"></th>
                    <th class="col-day col-day-week" data-day="9"></th><th class="col-day col-day-week" data-day="10"></th>
                    <th class="col-day col-day-week" data-day="11"></th><th class="col-day col-day-week" data-day="12"></th>
                    <th class="col-day col-day-week" data-day="13"></th><th class="col-day col-day-week" data-day="14"></th>
                    <th class="col-day col-day-week" data-day="15"></th><th class="col-day col-day-week" data-day="16"></th>
                    <th class="col-day col-day-week" data-day="17"></th><th class="col-day col-day-week" data-day="18"></th>
                    <th class="col-day col-day-week" data-day="19"></th><th class="col-day col-day-week" data-day="20"></th>
                    <th class="col-day col-day-week" data-day="21"></th><th class="col-day col-day-week" data-day="22"></th>
                    <th class="col-day col-day-week" data-day="23"></th><th class="col-day col-day-week" data-day="24"></th>
                    <th class="col-day col-day-week" data-day="25"></th><th class="col-day col-day-week" data-day="26"></th>
                    <th class="col-day col-day-week" data-day="27"></th><th class="col-day col-day-week" data-day="28"></th>
                    <th class="col-day col-day-week" data-day="29"></th><th class="col-day col-day-week" data-day="30"></th>
                    <th class="col-day col-day-week" data-day="31"></th>
                  </tr>
                </thead>
                <tbody id="habits-tbody"></tbody>
              </table>
            </div>

            <div class="habits-actions">
              <button type="button" class="habits-btn" id="habits-add-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
              <button type="button" class="habits-btn habits-btn--danger" id="habits-clear-btn">–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—è—Ü</button>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>
  
</body>
<script>
(function () {
    const timers = new Map();
    let rowMenu = null;
    let rowMenuTargetRow = null;
    let editingRow = null;
    let dragRow = null;
    let dragPlaceholder = null;
    let isDragging = false;
    let currentActiveCell = null;

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ï–ö–£–©–ï–ì–û –ú–ï–°–Ø–¶–ê =====
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;

    const weekdayNamesShort = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];

    const productionDays = {
        2025: {
            '01-01': 'h','01-02': 'h','01-03': 'h','01-04': 'h','01-05': 'h',
            '01-06': 'h','01-07': 'h','01-08': 'h',
            '02-23': 'h','03-08': 'h','05-01': 'h','05-09': 'h',
            '06-12': 'h','11-04': 'h'
        },
        2026: {
            '01-01': 'h','01-02': 'h','01-03': 'h','01-04': 'h','01-05': 'h',
            '01-06': 'h','01-07': 'h','01-08': 'h','01-09': 'h','01-10': 'h','01-11': 'h',
            '02-23': 'h','03-08': 'h','05-01': 'h','05-09': 'h',
            '06-12': 'h','11-04': 'h','12-31': 'h'
        },
        2027: {
            '01-01': 'h','01-02': 'h','01-03': 'h','01-04': 'h','01-05': 'h',
            '01-06': 'h','01-07': 'h','01-08': 'h',
            '02-23': 'h','03-08': 'h','05-01': 'h','05-09': 'h',
            '06-12': 'h','11-04': 'h'
        }
    };

    function isProductionHoliday(date) {
        const year = date.getFullYear();
        const yearMap = productionDays[year];
        if (!yearMap) return false;
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return yearMap[mm + '-' + dd] === 'h';
    }

    function monthKey(year, month) {
        return year + '-' + String(month).padStart(2, '0');
    }

    function monthLabel(year, month) {
        return String(month).padStart(2, '0') + '.' + year;
    }

    const defaultHabitsTemplate = [
        { name:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',             unit:'–î–Ω–∏',      plan:12,  schedule:{type:'weeklyCount', weeklyTarget:3} },
        { name:'–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º',    unit:'–ß–∞—Å—ã',     plan:30,  schedule:{type:'weekdays'} },
        { name:'–°–º–æ—Ç—Ä–∏–º –ë—Ä–∏–Ω–∞',          unit:'–ß–∞—Å—ã',     plan:15,  schedule:{type:'weeklyCount', weeklyTarget:2} },
        { name:'–ò–Ω–≤–∏—Å—Ç–∏—Ü–∏–∏ –∏–∑—É—á–µ–Ω–∏–µ',    unit:'–ß–∞—Å—ã',     plan:10,  schedule:{type:'weeklyCount', weeklyTarget:2} },
        { name:'–ü—Ä–æ–µ–∫—Ç "–∞–π—Ñ"',           unit:'–°—á–µ—Ç–∞',    plan:4,   schedule:{type:'monthlyFixed'} },
        { name:'–ò—Å–∫–ª. –°–æ—Ü. –°–µ—Ç–∏',        unit:'–î–Ω–∏<1—á/–¥', plan:23,  schedule:{type:'weekdays'} },
        { name:'–ò—Å–∫–ª. –•–∞—Ä—Ç—Å—Ç–æ—É–Ω',        unit:'–î–Ω–∏<1—á/–¥', plan:31,  schedule:{type:'daily'} },
        { name:'–ú–æ—Ç–æ—Ä–∏–∫–∞ –≤–µ–¥–µ–Ω–∏–µ',       unit:'–î–Ω–∏',      plan:31,  schedule:{type:'daily'} },
        { name:'–í–µ–¥–µ–Ω–∏–µ –í–∞–∂–Ω–æ–µ,–°—Ä–æ—á–Ω–æ–µ', unit:'–î–Ω–∏',      plan:31,  schedule:{type:'daily'} },
        { name:'–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞ –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å', unit:'–î–Ω–∏',      plan:12,  schedule:{type:'weeklyCount', weeklyTarget:3} },
        { name:'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ —Å–ø–∏–Ω—É',    unit:'–î–Ω–∏',      plan:23,  schedule:{type:'weekdays'} },
        { name:'–ü–æ–º–Ω–∏—Ç—å —Ä–∞–¥–∏ —á–µ–≥–æ –≤—Å–µ',  unit:'–î–Ω–∏',      plan:31,  schedule:{type:'daily'} }
    ];

    function getStoredMonthKeys() {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (!k) continue;
            if (k.startsWith('habits:order:')) {
                const mk = k.substring('habits:order:'.length);
                if (mk.includes('-') && !keys.includes(mk)) keys.push(mk);
            } else if (k.startsWith('habits:')) {
                const rest = k.substring('habits:'.length);
                const mk = rest.split(':')[0];
                if (mk.includes('-') && !keys.includes(mk)) keys.push(mk);
            }
        }
        keys.sort();
        return keys;
    }

    function getUnitType(unit) {
        const unitLower = unit.toLowerCase();
        if (unitLower.includes('—á–∞—Å')) return 'time';
        if (unitLower.includes('–∫–æ–ª-–≤–æ') || unitLower.includes('—Å—á–µ—Ç–∞')) return 'count';
        return 'check';
    }

    function getCellClass(unit) {
        const type = getUnitType(unit);
        if (type === 'time') return 'habit-cell--time';
        if (type === 'count') return 'habit-cell--count';
        return 'habit-cell--check';
    }

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–ï–°–Ø–¶–ê =====
    function initMonthSelect() {
        const button = document.getElementById('habits-month-button');
        const dropdown = document.getElementById('habits-month-dropdown');
        if (!button || !dropdown) return;

        const mkCurrent = monthKey(currentYear, currentMonth);
        const keys = getStoredMonthKeys();
        if (!keys.includes(mkCurrent)) {
            keys.push(mkCurrent);
            keys.sort();
        }

        dropdown.innerHTML = '';
        keys.forEach(mk => {
            const [y, m] = mk.split('-');
            const opt = document.createElement('div');
            opt.className = 'habits-month-option' + (mk === mkCurrent ? ' habits-month-option--active' : '');
            opt.dataset.value = mk;
            opt.textContent = monthLabel(Number(y), Number(m));
            dropdown.appendChild(opt);
        });

        button.textContent = monthLabel(currentYear, currentMonth);

        button.onclick = function () {
            const isHidden = dropdown.hasAttribute('hidden');
            if (isHidden) {
                dropdown.removeAttribute('hidden');
            } else {
                dropdown.setAttribute('hidden', '');
            }
        };

        dropdown.onclick = function (e) {
            const opt = e.target.closest('.habits-month-option');
            if (!opt) return;
            const mk = opt.dataset.value;
            const [y, m] = mk.split('-');
            currentYear = Number(y);
            currentMonth = Number(m);
            dropdown.querySelectorAll('.habits-month-option').forEach(el => {
                el.classList.toggle('habits-month-option--active', el === opt);
            });
            button.textContent = monthLabel(currentYear, currentMonth);
            dropdown.setAttribute('hidden', '');
            createHabitsFromTemplate();
            applyRowsOrder();
            loadAllCellsState();
            highlightTodayColumn();
            updateWeekdayHeader();
        };

        document.addEventListener('click', function onDocClick(e) {
            if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.setAttribute('hidden', '');
            }
        });
    }


// ===== –°–û–ó–î–ê–ù–ò–ï –°–¢–†–û–ö –¢–ê–ë–õ–ò–¶–´ =====
async function createHabitsFromTemplate() {
    const tbody = document.getElementById('habits-tbody');
    if (!tbody) return;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–≤—ã—á–∫–∏ –∏–∑ API
    const habits = await loadHabitsFromAPI();
    
    if (habits.length === 0) {
        tbody.innerHTML = '';
        return;
    }

    tbody.innerHTML = '';

    habits.forEach((habit) => {
        const row = document.createElement('tr');
        row.className = 'habit-row';
        row.dataset.habitId = String(habit.id); // ID –∏–∑ –ë–î

        const cellClass = getCellClass(habit.unit);

        row.innerHTML = `
            <td class="col-task habit-name sticky sticky-col-1"></td>
            <td class="col-unit habit-unit sticky sticky-col-2"></td>
            <td class="col-plan habit-plan sticky sticky-col-3"></td>
        `;

        const cells = row.querySelectorAll('td');
        cells[0].textContent = habit.name;
        cells[1].textContent = habit.unit;
        cells[2].textContent = habit.plan;

        for (let day = 1; day <= 31; day++) {
            const td = document.createElement('td');
            td.className = 'habit-cell ' + cellClass;
            td.dataset.day = String(day);
            row.appendChild(td);
        }

        const resultTd = document.createElement('td');
        resultTd.className = 'col-result habit-result';
        resultTd.textContent = '0';
        row.appendChild(resultTd);

        const percentTd = document.createElement('td');
        percentTd.className = 'col-percent habit-percent';
        percentTd.innerHTML = `
            <div class="habit-percent-bar">
                <div class="habit-percent-bar__fill" style="width:0%"></div>
                <span class="habit-percent-bar__label">0%</span>
            </div>
        `;
        row.appendChild(percentTd);

        tbody.appendChild(row);
    });

    updateWeekdayHeader();
}



// ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–¢–†–û–ö–ò =====
function startEditRow(row) {
  if (!row) return;
  
  // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥—É—é —Å—Ç—Ä–æ–∫—É - –∑–∞–∫–æ–Ω—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  if (editingRow && editingRow !== row) {
    finishEditRow();
  }
  
  editingRow = row;
  row.classList.add('habit-row--active');
  
  const nameCell = row.querySelector('.habit-name');
  const unitCell = row.querySelector('.habit-unit');
  const planCell = row.querySelector('.habit-plan');
  
  if (!nameCell || !unitCell || !planCell) return;
  
  makeCellEditable(nameCell, 'text');
  makeCellEditable(unitCell, 'text');
  makeCellEditable(planCell, 'number');
}

function makeCellEditable(cell, type) {
  if (!cell || cell.dataset.editing === '1') return;
  const oldText = cell.textContent.trim();
  cell.dataset.oldValue = oldText;
  cell.dataset.editing = '1';
  
  let input;
  
  // –ï—Å–ª–∏ —ç—Ç–æ —è—á–µ–π–∫–∞ "–ï–¥. –∏–∑–º." - —Å–æ–∑–¥–∞—ë–º select —Å –æ–ø—Ü–∏—è–º–∏
  if (cell.classList.contains('habit-unit')) {
    input = document.createElement('select');
    input.className = 'habit-edit-input habit-edit-select';
    
    const options = [
      { value: '–¥–Ω–∏', label: '–î–Ω–∏' },
      { value: '—á–∞—Å—ã', label: '–ß–∞—Å—ã' },
      { value: '–∫–æ–ª-–≤–æ', label: '–ö–æ–ª-–≤–æ' },
      { value: '–¥—Ä—É–≥–æ–µ', label: '–î—Ä—É–≥–æ–µ...' }
    ];
    
    options.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt.value;
      option.textContent = opt.label;
      if (oldText.toLowerCase().includes(opt.value)) {
        option.selected = true;
      }
      input.appendChild(option);
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
    const hasMatch = options.some(opt => oldText.toLowerCase().includes(opt.value));
    if (!hasMatch && oldText) {
      const customOption = document.createElement('option');
      customOption.value = oldText;
      customOption.textContent = oldText;
      customOption.selected = true;
      input.appendChild(customOption);
    }
    
  } else {
    // –û–±—ã—á–Ω—ã–π input –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –ø–ª–∞–Ω–∞
    input = document.createElement('input');
    input.type = type === 'number' ? 'number' : 'text';
    input.className = 'habit-edit-input';
    input.value = oldText;
  }
  
  input.autofocus = true;
  cell.textContent = '';
  cell.appendChild(input);
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter/Escape
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      finishEditRow();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEditRow();
    }
    // –í–ê–ñ–ù–û: –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–ª–∞–≤–∏—à!
    // e.stopPropagation() –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è Del/Backspace
    if (e.key === 'Delete' || e.key === 'Backspace') {
      e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
    }
  });
  
  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ "–î—Ä—É–≥–æ–µ" - –∑–∞–º–µ–Ω—è–µ–º select –Ω–∞ input
  if (input.tagName === 'SELECT') {
    input.addEventListener('change', function() {
      if (this.value === '–¥—Ä—É–≥–æ–µ') {
        const customInput = document.createElement('input');
        customInput.type = 'text';
        customInput.className = 'habit-edit-input';
        customInput.value = '';
        customInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é –µ–¥–∏–Ω–∏—Ü—É...';
        customInput.autofocus = true;
        
        cell.textContent = '';
        cell.appendChild(customInput);
        customInput.focus();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ input
        customInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            finishEditRow();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEditRow();
          }
          if (e.key === 'Delete' || e.key === 'Backspace') {
            e.stopPropagation();
          }
        });
        
        customInput.addEventListener('blur', function() {
          setTimeout(() => {
            if (!rowContainsFocusedInput(editingRow)) finishEditRow();
          }, 0);
        });
      }
    });
  }
  
  input.addEventListener('blur', function() {
    setTimeout(() => {
      if (!rowContainsFocusedInput(editingRow)) finishEditRow();
    }, 0);
  });
  
  // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ input
  setTimeout(() => input.focus(), 10);
}


async function finishEditRow() {
    if (!editingRow) return;
    const row = editingRow;
    const habitId = row.dataset.habitId;
    const nameCell = row.querySelector('.habit-name');
    const unitCell = row.querySelector('.habit-unit');
    const planCell = row.querySelector('.habit-plan');

    const name = extractInputValue(nameCell);
    const unit = extractInputValue(unitCell);
    const plan = extractInputValue(planCell);

    nameCell.textContent = name;
    unitCell.textContent = unit;
    planCell.textContent = plan;

    clearCellEditingFlags(nameCell);
    clearCellEditingFlags(unitCell);
    clearCellEditingFlags(planCell);

    // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ API
    const updated = await updateHabitAPI(habitId, name, unit, Number(plan) || 0);
    
    if (!updated) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏!');
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø —è—á–µ–µ–∫
    const newCellClass = getCellClass(unit);
    row.querySelectorAll('.habit-cell').forEach(cell => {
        cell.className = 'habit-cell ' + newCellClass + (cell.dataset.day ? '' : '');
        cell.dataset.day = cell.dataset.day;
    });

    row.classList.remove('habit-row--active');
    editingRow = null;
    updateRowResult(row);
}

    function cancelEditRow() {
        if (!editingRow) return;

        const row = editingRow;
        const nameCell = row.querySelector('.habit-name');
        const unitCell = row.querySelector('.habit-unit');
        const planCell = row.querySelector('.habit-plan');

        restoreCellFromOldValue(nameCell);
        restoreCellFromOldValue(unitCell);
        restoreCellFromOldValue(planCell);

        row.classList.remove('habit-row--active');
        editingRow = null;
    }

function extractInputValue(cell) {
  if (!cell) return '';
  const input = cell.querySelector('.habit-edit-input');
  if (!input) return cell.textContent.trim();
  
  // –ï—Å–ª–∏ —ç—Ç–æ select –∏ –≤—ã–±—Ä–∞–Ω–æ "–¥—Ä—É–≥–æ–µ" - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
  if (input.tagName === 'SELECT' && input.value === '–¥—Ä—É–≥–æ–µ') {
    return '';
  }
  
  return input.value.trim();
}


    function clearCellEditingFlags(cell) {
        if (!cell) return;
        delete cell.dataset.oldValue;
        delete cell.dataset.editing;
    }

    function restoreCellFromOldValue(cell) {
        if (!cell) return;
        const old = cell.dataset.oldValue || '';
        cell.textContent = old;
        clearCellEditingFlags(cell);
    }

    function rowContainsFocusedInput(row) {
        if (!row) return false;
        const active = document.activeElement;
        return !!active && row.contains(active) && active.classList.contains('habit-edit-input');
    }

    function saveRowMetaToStorage(habitId, name, unit, plan) {
        if (!habitId) return;
        const key = 'habits:rowmeta:' + habitId;
        const payload = { name, unit, plan };
        try {
            localStorage.setItem(key, JSON.stringify(payload));
        } catch (e) {}
    }

    function loadRowMetaFromStorage(row) {
        const habitId = row.dataset.habitId;
        if (!habitId) return;
        const key = 'habits:rowmeta:' + habitId;
        let raw = null;
        try {
            raw = localStorage.getItem(key);
        } catch (e) {
            raw = null;
        }
        if (!raw) return;

        try {
            const meta = JSON.parse(raw);
            if (!meta) return;
            if (meta.name) row.querySelector('.habit-name').textContent = meta.name;
            if (meta.unit) row.querySelector('.habit-unit').textContent = meta.unit;
            if (meta.plan !== undefined) row.querySelector('.habit-plan').textContent = meta.plan;
        } catch (e) {}
    }

    // ===== –ú–ï–ù–Æ –°–¢–†–û–ö =====
    function getRowMenu() {
        if (!rowMenu) {
            rowMenu = document.getElementById('habit-row-menu');
        }
        return rowMenu;
    }

    function closeRowMenu() {
        const menu = getRowMenu();
        if (menu) {
            menu.style.display = 'none';
            menu.hidden = false;
        }
        if (rowMenuTargetRow) {
            rowMenuTargetRow.classList.remove('habit-row--active');
            rowMenuTargetRow = null;
        }
    }

    function openRowMenu(row, x, y) {
        const menu = getRowMenu();
        if (!menu || !row) return;

        closeRowMenu();

        rowMenuTargetRow = row;
        row.classList.add('habit-row--active');

        menu.hidden = false;
        menu.style.display = 'block';

        let left = x + window.scrollX;
        let top  = y + window.scrollY;

        menu.style.left = left + 'px';
        menu.style.top  = top  + 'px';

        const rect    = menu.getBoundingClientRect();
        const vpWidth = window.innerWidth;
        const vpHeight = window.innerHeight;

        if (rect.right > vpWidth) {
            left -= (rect.right - vpWidth) + 8;
        }
        if (rect.bottom > vpHeight) {
            top -= (rect.bottom - vpHeight) + 8;
        }

        menu.style.left = left + 'px';
        menu.style.top  = top  + 'px';
    }

    document.addEventListener('click', function (e) {
        const menu = getRowMenu();
        if (!menu) return;

        const clickedInsideMenu = menu.contains(e.target);
        const clickedRow = e.target.closest('.habit-row');

        if (!clickedInsideMenu && (!rowMenuTargetRow || clickedRow !== rowMenuTargetRow)) {
            closeRowMenu();
        }
    });

    // ===== –õ–û–ì–ò–ö–ê –Ø–ß–ï–ï–ö =====
    function formatHours(value) {
        return (Math.round(value * 100) / 100).toString();
    }

    function cellKey(cell) {
        const row = cell.closest('.habit-row');
        const habitId = row?.dataset.habitId || 'row-' + Array.from(row.parentNode.children).indexOf(row);
        const day = cell.dataset.day || '';
        return habitId + ':' + day;
    }

    // –í–†–ï–ú–Ø: –ü–ö–ú +1 —á–∞—Å
    function onCellContextMenuTime(e, cell) {
        e.preventDefault();
        const current = parseFloat(cell.textContent.replace(',', '.')) || 0;
        const next = current + 1;
        cell.textContent = formatHours(next);
        updateFilledState(cell);
        saveCellState(cell);
        updateRowResult(cell.closest('.habit-row'));
    }

    // –í–†–ï–ú–Ø: –õ–ö–ú –∑–∞–ø—É—Å–∫/—Å—Ç–æ–ø —Ç–∞–π–º–µ—Ä–∞ (–ë–ï–ó —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è 1)
    function onCellClickTime(cell) {
        const key = cellKey(cell);
        const entry = timers.get(key);

        if (!entry) {
            startTimer(cell);
        } else {
            stopTimer(cell);
        }
    }

    function startTimer(cell) {
        const key = cellKey(cell);
        if (timers.has(key)) return;
        cell.classList.add('habit-cell--running');
        timers.set(key, { start: performance.now() });
    }

    function stopTimer(cell) {
        const key = cellKey(cell);
        const entry = timers.get(key);
        if (!entry) return;

        const elapsedMs = performance.now() - entry.start;
        timers.delete(key);
        cell.classList.remove('habit-cell--running');

        const minutes = elapsedMs / 1000 / 60;
        const hours = minutes / 60;

        const current = parseFloat(cell.textContent.replace(',', '.')) || 0;
        const next = current + hours;
        cell.textContent = formatHours(next);
        updateFilledState(cell);
        saveCellState(cell);
        updateRowResult(cell.closest('.habit-row'));
    }

    // –í–†–ï–ú–Ø: –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ -1 —á–∞—Å
    function onCellDblClickTime(cell) {
        const current = parseFloat(cell.textContent.replace(',', '.')) || 0;
        let next = current - 1;

        if (next <= 0) {
            cell.textContent = '';
        } else {
            cell.textContent = formatHours(next);
        }

        updateFilledState(cell);
        saveCellState(cell);
        updateRowResult(cell.closest('.habit-row'));
    }

    // –°–ß–ï–¢–ê: –õ–ö–ú +1
    function onCellClickCount(cell) {
        const current = parseInt(cell.textContent, 10) || 0;
        const next = current + 1;
        cell.textContent = next;

        updateFilledState(cell);
        saveCellState(cell);
        updateRowResult(cell.closest('.habit-row'));
    }

    // –°–ß–ï–¢–ê: –ü–ö–ú -1
    function onCellContextMenuCount(e, cell) {
        e.preventDefault();
        const current = parseInt(cell.textContent, 10) || 0;
        const next = Math.max(0, current - 1);
        cell.textContent = next || '';

        updateFilledState(cell);
        saveCellState(cell);
        updateRowResult(cell.closest('.habit-row'));
    }

    // –ì–ê–õ–û–ß–ö–ò: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
    function toggleCheckCell(cell) {
        cell.classList.toggle('checked');
        cell.textContent = cell.classList.contains('checked') ? '‚úì' : '';
        updateFilledState(cell);
        saveCellState(cell);
        const row = cell.closest('.habit-row');
        if (row) {
            updateRowResult(row);
        }
    }

async function saveCellState(cell) {
    const row = cell.closest('.habit-row');
    if (!row) return;

    const habitId = row.dataset.habitId;
    const day = Number(cell.dataset.day);
    if (!habitId || !day) return;

    const mk = monthKey(currentYear, currentMonth);
    const [year, month] = mk.split('-').map(Number);

    let value = null;

    if (cell.classList.contains('habit-cell--time')) {
        value = cell.textContent.trim() || '0';
    } else if (cell.classList.contains('habit-cell--check')) {
        value = cell.classList.contains('checked') ? '‚úì' : '0';
    } else if (cell.classList.contains('habit-cell--count')) {
        value = cell.textContent.trim() || '0';
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    await saveHabitRecord(habitId, year, month, day, value);
}


async function loadAllCellsState() {
  const tbody = document.getElementById('habits-tbody');
  if (!tbody) {
    console.warn('tbody not found');
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–≤—ã—á–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
  const rows = tbody.querySelectorAll('.habit-row');
  if (rows.length === 0) {
    console.warn('No habit rows found, waiting...');
    // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ 100–º—Å
    setTimeout(() => loadAllCellsState(), 100);
    return;
  }
  
  const mk = monthKey(currentYear, currentMonth);
  const [year, month] = mk.split('-').map(Number);
  
  console.log(`Loading records for ${year}-${month}`);
  
  // API
  const records = await loadHabitRecordsForMonth(year, month);
  
  if (!records || records.length === 0) {
    console.log('No records found for this month');
    return;
  }
  
  console.log(`Loaded ${records.length} records`);
  
  // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —è—á–µ–π–∫–∏
  tbody.querySelectorAll('.habit-cell').forEach(cell => {
    cell.textContent = '';
    cell.classList.remove('checked', 'filled');
  });
  
  // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–º–∏
records.forEach(record => {
  const row = tbody.querySelector(`tr[data-habit-id="${record.habitid}"]`);
  if (!row) {
    console.warn(`Row not found for habit ${record.habitid}`);
    return;
  }
  
  const cell = row.querySelector(`.habit-cell[data-day="${record.day}"]`);
  if (!cell) {
    console.warn(`Cell not found for day ${record.day} in habit ${record.habitid}`);
    return;
  }
  
  const value = record.value;
  console.log(`Loading: habitId=${record.habitid}, day=${record.day}, value=${value} (type: ${typeof value})`);
  
  // –î–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ (–ø—Ä–∏–≤—ã—á–∫–∏ —Ç–∏–ø–∞ "–≥–∞–ª–æ—á–∫–∞")
  if (cell.classList.contains('habit-cell--check')) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º == –≤–º–µ—Å—Ç–æ === –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —á–∏—Å–ª–∞ –∏ —Å—Ç—Ä–æ–∫–∏
    if (value == 1 || value === '‚úì') {
      cell.classList.add('checked');
      cell.textContent = '‚úì';
      console.log(`‚úì Cell checked for day ${record.day}`);
    } else {
      cell.classList.remove('checked');
      cell.textContent = '';
    }
  } 
  // –î–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤ –∏ —Ç–∞–π–º–µ—Ä–æ–≤
  else if (cell.classList.contains('habit-cell--time') || cell.classList.contains('habit-cell--count')) {
    if (value && value != 0 && value !== '0' && value !== '') {
      cell.textContent = value;
      console.log(`‚úì Cell filled with value "${value}" for day ${record.day}`);
    } else {
      cell.textContent = '';
    }
  }
  
  updateFilledState(cell);
});


  
  tbody.querySelectorAll('.habit-row').forEach(row => updateRowResult(row));
}




    function updateFilledState(cell) {
        if (!cell) return;

        const raw = cell.textContent.trim();

        if (raw === '') {
            cell.classList.remove('habit-cell--filled');
            cell.textContent = '';
            return;
        }

        const span = document.createElement('span');
        span.textContent = raw;
        cell.innerHTML = '';
        cell.appendChild(span);

        cell.classList.add('habit-cell--filled');
    }

    // ===== –†–ï–ó–£–õ–¨–¢–ê–¢–´ =====
    function updateRowResult(row) {
        if (!row) return;
        let sum = 0;

        row.querySelectorAll('.habit-cell--time').forEach(td => {
            const v = parseFloat(td.textContent.replace(',', '.'));
            if (!isNaN(v)) sum += v;
        });

        row.querySelectorAll('.habit-cell--check.checked').forEach(() => {
            sum += 1;
        });

        row.querySelectorAll('.habit-cell--count').forEach(td => {
            const v = parseInt(td.textContent, 10);
            if (!isNaN(v)) sum += v;
        });

        const resultCell = row.querySelector('.habit-result');
        if (resultCell) {
            resultCell.textContent = formatHours(sum);
        }

        const planCell = row.querySelector('.habit-plan');
        const percentCell = row.querySelector('.habit-percent');
        if (!planCell || !percentCell) return;

        const plan = parseFloat(planCell.textContent.replace(',', '.')) || 0;
        let percent = 0;

        if (plan > 0) {
            percent = Math.min(100, Math.round((sum / plan) * 100));
        }

        const bar = percentCell.querySelector('.habit-percent-bar__fill');
        const label = percentCell.querySelector('.habit-percent-bar__label');
        if (bar) {
            bar.style.width = percent + '%';
        }
        if (label) {
            label.textContent = percent + '%';
        }
    }

    // ===== –£–î–ê–õ–ï–ù–ò–ï –ü–†–ò–í–´–ß–ö–ò =====
    let lastDeletedHabit = null;
    let undoTimerId = null;
    let undoSecondsLeft = 0;

    function openHabitDeleteModal(row, name) {
        const backdrop = document.createElement('div');
        backdrop.className = 'habits-modal-backdrop';

        backdrop.innerHTML = `
          <div class="habits-modal" role="dialog" aria-modal="true">
            <h3 class="habits-modal__title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</h3>
            <p class="habits-modal__text">
              –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É <span class="habits-modal__name">"${name}"</span>?
            </p>
            <div class="habits-modal__actions">
              <button type="button" class="habits-modal__btn habits-modal__btn--cancel" data-role="cancel">
                –û—Ç–º–µ–Ω–∞
              </button>
              <button type="button" class="habits-modal__btn" data-role="ok">
                –û–∫
              </button>
            </div>
          </div>
        `;

        function closeModal() {
            document.removeEventListener('keydown', onKeyDown);
            backdrop.remove();
        }

        function onKeyDown(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        }

        backdrop.addEventListener('click', function (e) {
            const role = e.target.dataset.role;
            if (role === 'cancel') {
                closeModal();
            } else if (role === 'ok') {
                closeModal();
                deleteHabitRowWithUndo(row);
            }
        });

        document.addEventListener('keydown', onKeyDown);
        document.body.appendChild(backdrop);
    }

async function deleteHabitRowWithUndo(row) {
  const tbody = document.getElementById('habits-tbody');
  if (!tbody) return;

  const habitId = row.dataset.habitId;
  if (!habitId) return;

  const index = Array.prototype.indexOf.call(tbody.children, row);
  const data = { 
    html: row.outerHTML, 
    index: index,
    habitId: habitId
  };
  lastDeletedHabit = data;

  // –°—Ä–∞–∑—É —É–¥–∞–ª—è–µ–º –∏–∑ localStorage
  const mk = monthKey(currentYear, currentMonth);
  const key = 'habits:' + mk + ':' + habitId;
  try {
    localStorage.removeItem(key);
  } catch (e) {}

  const metaKey = 'habits:rowmeta:' + habitId;
  try {
    localStorage.removeItem(metaKey);
  } catch (e) {}

  // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
  if (tbody) {
    tbody.removeChild(row);
  }

  saveRowsOrder();
  showHabitUndoBanner();

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î (20 —Å–µ–∫—É–Ω–¥)
  setTimeout(async () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–º–µ–Ω–∏–ª
    if (lastDeletedHabit && lastDeletedHabit.habitId === habitId) {
      const deleted = await deleteHabitAPI(habitId);
      
      if (deleted) {
        lastDeletedHabit = null;
      }
    }
  }, 20000);
}




    function showHabitUndoBanner() {
        const existingBanner = document.getElementById('habits-undo-banner');
        if (existingBanner) {
            existingBanner.remove();
        }

        const section = document.querySelector('.block-habits-table') ||
                        document.querySelector('.table-wrapper');
        if (!section) return;

        const bannerWrapper = document.createElement('div');
        bannerWrapper.className = 'habits-undo-banner';
        bannerWrapper.id = 'habits-undo-banner';

        undoSecondsLeft = 20;

        bannerWrapper.innerHTML = `
          <button type="button" class="habits-undo-banner__btn" id="habits-undo-btn">
            –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (${undoSecondsLeft})
          </button>
        `;

        section.parentNode.insertBefore(bannerWrapper, section.nextSibling);

        const btn = document.getElementById('habits-undo-btn');
        if (!btn) return;

        btn.addEventListener('click', function () {
            undoDeleteHabit();
        });

        if (undoTimerId) {
            clearInterval(undoTimerId);
        }

undoTimerId = setInterval(function () {
    undoSecondsLeft -= 1;
    if (undoSecondsLeft <= 0) {
        clearInterval(undoTimerId);
        undoTimerId = null;
        removeHabitUndoBanner();
        // ‚úÖ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º lastDeletedHabit –∑–¥–µ—Å—å!
        // –û–Ω —Å–±—Ä–æ—Å–∏—Ç—Å—è –≤ setTimeout –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –ë–î
        return;
            }
            btn.textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (' + undoSecondsLeft + ')';
        }, 1000);
    }

function removeHabitUndoBanner() {
  console.log('üî• removeHabitUndoBanner called');
  
  const banner = document.getElementById('habits-undo-banner');
  if (banner) {
    banner.remove();
  }

  if (undoTimerId) {
    clearInterval(undoTimerId);
    undoTimerId = null;
  }
  
  // ‚ùå –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú lastDeletedHabit –∑–¥–µ—Å—å!
  // lastDeletedHabit = null; // ‚Üê –£–î–ê–õ–ò –≠–¢–£ –°–¢–†–û–ö–£, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  
  console.log('üî• Banner removed, but lastDeletedHabit NOT reset');
}

function undoDeleteHabit() {
  if (!lastDeletedHabit) return;

  const tbody = document.getElementById('habits-tbody');
  if (!tbody) return;

  const temp = document.createElement('tbody');
  temp.innerHTML = lastDeletedHabit.html;
  const restoredRow = temp.firstElementChild;
  if (!restoredRow) return;

  const rows = tbody.children;
  if (lastDeletedHabit.index >= rows.length) {
    tbody.appendChild(restoredRow);
  } else {
    tbody.insertBefore(restoredRow, rows[lastDeletedHabit.index]);
  }

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ localStorage
  const habitId = restoredRow.dataset.habitId;
  const nameCell = restoredRow.querySelector('.habit-name');
  const unitCell = restoredRow.querySelector('.habit-unit');
  const planCell = restoredRow.querySelector('.habit-plan');
  
  if (nameCell && unitCell && planCell && habitId) {
    saveRowMetaToStorage(habitId, nameCell.textContent, unitCell.textContent, planCell.textContent);
  }

  // –í–ê–ñ–ù–û: –û—Ç–º–µ–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º lastDeletedHabit)
  lastDeletedHabit = null;

  removeHabitUndoBanner();

  if (undoTimerId) {
    clearInterval(undoTimerId);
    undoTimerId = null;
  }

  tbody.querySelectorAll('.habit-row').forEach(updateRowResult);
  saveRowsOrder();
  
  showNotification('–ü—Ä–∏–≤—ã—á–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'success');
}


async function deleteHabitAPI(habitId) {
  const token = localStorage.getItem('app-auth-token');
  
  if (!token) {
    console.warn('No auth token found');
    return false;
  }

  try {
    const response = await fetch(`${API_URL}/api/habits/${habitId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      const error = await response.json();
      console.error('Delete habit error:', error);
      return false;
    }

    console.log('Habit deleted from backend:', habitId);
    return true;
  } catch (error) {
    console.error('Delete habit API call failed:', error);
    return false;
  }
}


    // ===== –ü–û–†–Ø–î–û–ö –°–¢–†–û–ö =====
    function saveRowsOrder() {
        const tbody = document.getElementById('habits-tbody');
        if (!tbody) return;
        const ids = Array.from(tbody.querySelectorAll('.habit-row'))
            .map(r => r.dataset.habitId);
        const mk = monthKey(currentYear, currentMonth);
        const key = 'habits:order:' + mk;
        try {
            localStorage.setItem(key, JSON.stringify(ids));
        } catch (e) {}
    }

    function applyRowsOrder() {
        const tbody = document.getElementById('habits-tbody');
        if (!tbody) return;
        const mk = monthKey(currentYear, currentMonth);
        const key = 'habits:order:' + mk;

        let raw = null;
        try {
            raw = localStorage.getItem(key);
        } catch (e) {
            raw = null;
        }
        if (!raw) return;

        let ids;
        try {
            ids = JSON.parse(raw);
        } catch (e) {
            return;
        }
        if (!Array.isArray(ids)) return;

        const rowsById = {};
        tbody.querySelectorAll('.habit-row').forEach(r => {
            rowsById[r.dataset.habitId] = r;
        });

        ids.forEach(id => {
            const row = rowsById[id];
            if (row) {
                tbody.appendChild(row);
            }
        });
    }

    // ===== –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –°–¢–†–û–ö =====
    function startMoveRow(row) {
        if (!row) return;
        if (editingRow && editingRow !== row) {
            finishEditRow();
        }
        dragRow = row;
        isDragging = true;
        row.classList.add('habit-row--moving');
    }

    function finishMoveRow() {
        if (!dragRow) return;
        dragRow.classList.remove('habit-row--moving');
        dragRow = null;
        isDragging = false;
        removeDragPlaceholder();
        saveRowsOrder();
    }

    function cancelMoveRow() {
        if (!dragRow) return;
        dragRow.classList.remove('habit-row--moving');
        dragRow = null;
        isDragging = false;
        removeDragPlaceholder();
    }

    function createDragPlaceholder() {
        if (dragPlaceholder || !dragRow) return;
        dragPlaceholder = document.createElement('tr');
        dragPlaceholder.className = 'habit-row habit-row--placeholder';
        dragPlaceholder.style.height = dragRow.getBoundingClientRect().height + 'px';
        const colCount = dragRow.children.length;
        for (let i = 0; i < colCount; i++) {
            const td = document.createElement('td');
            dragPlaceholder.appendChild(td);
        }
    }

    function removeDragPlaceholder() {
        if (dragPlaceholder && dragPlaceholder.parentNode) {
            dragPlaceholder.parentNode.removeChild(dragPlaceholder);
        }
        dragPlaceholder = null;
    }

    // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ù–¢–ï–ö–°–¢–ù–û–ì–û –ú–ï–ù–Æ =====
    document.addEventListener('contextmenu', function (e) {
        const cell  = e.target.closest('.habit-cell, .habit-name, .habit-unit, .habit-plan');
        const table = cell ? cell.closest('#habits-table') : null;

        if (dragRow && !table) {
            e.preventDefault();
            cancelMoveRow();
            return;
        }

        if (!cell || !table) return;

        const row = cell.closest('.habit-row');

        // –ü–ö–ú –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º: –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Å—Ç—Ä–æ–∫–∏
        if (cell.classList.contains('habit-name') ||
            cell.classList.contains('habit-unit') ||
            cell.classList.contains('habit-plan')) {

            e.preventDefault();
            openRowMenu(row, e.clientX, e.clientY);
            return;
        }

        closeRowMenu();

        // –ü–ö–ú –ø–æ —è—á–µ–π–∫–∞–º –¥–∞–Ω–Ω—ã—Ö
        if (cell.classList.contains('habit-cell--time')) {
            onCellContextMenuTime(e, cell);
        } else if (cell.classList.contains('habit-cell--count')) {
            onCellContextMenuCount(e, cell);
        }
    });

    // ===== –ö–õ–ò–ö–ò –ü–û –ú–ï–ù–Æ –°–¢–†–û–ö =====
    document.addEventListener('click', function (e) {
        const menu = getRowMenu();
        const item = e.target.closest('.habit-row-menu__item');

        if (item && menu && !menu.hidden) {
            const action = item.dataset.action;
            const row = rowMenuTargetRow;

            if (!row) {
                closeRowMenu();
                return;
            }

            if (action === 'edit') {
                startEditRow(row);
            } else if (action === 'move') {
                startMoveRow(row);
            } else if (action === 'delete') {
                const nameCell = row.querySelector('.habit-name');
                const name = nameCell ? nameCell.textContent.trim() : '';
                openHabitDeleteModal(row, name);
            }

            closeRowMenu();
            return;
        }

        if (editingRow) {
            const row = editingRow;
            if (!row.contains(e.target)) {
                finishEditRow();
            }
        }

        if (dragRow) {
            const row = dragRow;
            if (!row.contains(e.target)) {
                cancelMoveRow();
            }
        }
    });

    // ===== –ö–õ–ò–ö–ò –ü–û –Ø–ß–ï–ô–ö–ê–ú =====
    const habitsTbody = document.getElementById('habits-tbody');

    if (habitsTbody) {
        habitsTbody.addEventListener('click', function (e) {
            const cell = e.target.closest('.habit-cell');
            if (!cell) return;

            if (cell.classList.contains('habit-cell--check')) {
                toggleCheckCell(cell);
                return;
            }

            if (cell.classList.contains('habit-cell--time')) {
                onCellClickTime(cell);
                return;
            }

            if (cell.classList.contains('habit-cell--count')) {
                onCellClickCount(cell);
                currentActiveCell = cell;
                return;
            }
        });

        habitsTbody.addEventListener('dblclick', function (e) {
            const cell = e.target.closest('.habit-cell');
            if (!cell) return;

            if (cell.classList.contains('habit-cell--time')) {
                onCellDblClickTime(cell);
            }
        });
    }

// –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–∏ —Å—Ç—Ä–æ–∫–∏ –ë–ï–ó –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
function recalculateRowTotals(row) {
  if (!row) return;
  
  const plan = parseInt(row.querySelector('.habit-plan')?.textContent || 0);
  if (plan <= 0) return;
  
  let sum = 0;
  const cells = row.querySelectorAll('.habit-cell');
  
  cells.forEach(cell => {
    const input = cell.querySelector('input[type="number"]');
    if (input) {
      const val = parseFloat(input.value || 0);
      sum += val;
    } else if (cell.classList.contains('checked')) {
      sum += 1;
    } else {
      const text = cell.textContent.trim();
      if (text && !isNaN(text)) {
        sum += parseFloat(text);
      }
    }
  });
  
  const result = Math.round(sum * 100) / 100;
  const percent = Math.min(100, Math.round((result / plan) * 100));
  
  const resultCell = row.querySelector('.habit-result');
  const percentCell = row.querySelector('.habit-percent-bar__label');
  const fillBar = row.querySelector('.habit-percent-bar__fill');
  
  if (resultCell) resultCell.textContent = result;
  if (percentCell) percentCell.textContent = percent + '%';
  if (fillBar) fillBar.style.width = percent + '%';
}

// Delete - –æ—á–∏—Å—Ç–∫–∞ —è—á–µ–π–∫–∏
document.addEventListener('keydown', async function(e) {
    if (e.key === 'Delete' || e.key === 'Backspace') {
        const activeElement = document.activeElement;
        
        console.log('üî• Del pressed, activeElement:', activeElement?.tagName, activeElement?.className);
        
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º Delete –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const authModal = document.getElementById('auth-modal');
    if (authModal && authModal.classList.contains('active')) {
      console.log('‚úÖ Ignoring Delete: auth modal is open');
      return;
    }

        
        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ/–µ–¥–∏–Ω–∏—Ü–∞/–ø–ª–∞–Ω - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
        if (activeElement && activeElement.classList.contains('habit-edit-input')) {
            console.log('‚ùå Skipping: edit input');
            return;
        }
        
        // ‚úÖ –ò–©–ï–ú –Ø–ß–ï–ô–ö–£ –õ–Æ–ë–´–ú–ò –°–ü–û–°–û–ë–ê–ú–ò
        let targetCell = null;
        
        // 1. –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç - input, –∏—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —è—á–µ–π–∫—É
        if (activeElement && activeElement.tagName === 'INPUT') {
            targetCell = activeElement.closest('.habit-cell');
            
            // –ï—Å–ª–∏ input –Ω–µ –ø—É—Å—Ç–æ–π - –ø–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª—è—Ç—å —Ü–∏—Ñ—Ä—ã
            if (activeElement.type === 'number' && activeElement.value !== '') {
                console.log('‚ùå Input not empty, allowing normal delete');
                return;
            }
        }
        
        // 2. –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç - —Å–∞–º–∞ —è—á–µ–π–∫–∞
        if (!targetCell && activeElement && activeElement.classList.contains('habit-cell')) {
            targetCell = activeElement;
        }
        
        // 3. –ò—Å–ø–æ–ª—å–∑—É–µ–º currentActiveCell –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
        if (!targetCell && currentActiveCell) {
            targetCell = currentActiveCell;
        }
        
        // 4. –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å - –∏—â–µ–º —è—á–µ–π–∫—É —á–µ—Ä–µ–∑ :hover
        if (!targetCell) {
            targetCell = document.querySelector('.habit-cell:hover');
        }
        
        console.log('üî• Final targetCell:', targetCell);
        
        if (!targetCell) {
            console.log('‚ùå No targetCell found!');
            return;
        }
        
        e.preventDefault();
        
        const row = targetCell.closest('.habit-row');
        if (!row) return;
        
        const habitId = row.dataset.habitId;
        const day = targetCell.dataset.day;
        
        if (!habitId || !day) return;
        
        console.log('‚úÖ Deleting cell:', habitId, day);
        
        // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        targetCell.textContent = '';
        targetCell.classList.remove('checked', 'habit-cell--filled');
        
        // ‚úÖ –ï—Å–ª–∏ —ç—Ç–æ input (–¥–ª—è —á–∞—Å–æ–≤) - –æ—á–∏—â–∞–µ–º –µ–≥–æ
        const input = targetCell.querySelector('input[type="number"]');
        if (input) {
            input.value = '';
            input.blur();
        }
        
        // ‚úÖ –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ DELETE API
        const deleted = await deleteHabitRecord(habitId, currentYear, currentMonth, parseInt(day));
        
        if (deleted) {
            console.log('‚úÖ Cell cleared via API:', habitId, day);
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ localStorage
            const mk = monthKey(currentYear, currentMonth);
            const key = `habits:${mk}:${habitId}`;
            try {
                const stored = localStorage.getItem(key);
                if (stored) {
                    const data = JSON.parse(stored);
                    delete data[day];
                    localStorage.setItem(key, JSON.stringify(data));
                }
            } catch (e) {}
        }
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
        if (typeof recalculateRowTotals === 'function') {
            recalculateRowTotals(row);
        }
    }
});



    // ===== –ö–õ–ê–í–ò–®–ê Escape =====
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeRowMenu();
            cancelEditRow();
            cancelMoveRow();
        }
    });

    // ===== –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï =====
    document.addEventListener('mousedown', function (e) {
        if (!dragRow) return;
        const row = e.target.closest('.habit-row');
        if (!row || row !== dragRow) return;
        if (e.button !== 0) return;

        isDragging = true;
        createDragPlaceholder();

        const tbody = document.getElementById('habits-tbody');
        if (tbody && dragPlaceholder && dragRow.parentNode === tbody) {
            tbody.insertBefore(dragPlaceholder, dragRow.nextSibling);
        }

        e.preventDefault();
    });

    document.addEventListener('mousemove', function (e) {
        if (!isDragging || !dragRow) return;

        const tbody = document.getElementById('habits-tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('.habit-row'))
            .filter(r => r !== dragRow);
        const y = e.clientY;

        let targetRow = null;
        for (const r of rows) {
            const rect = r.getBoundingClientRect();
            if (y < rect.top + rect.height / 2) {
                targetRow = r;
                break;
            }
        }

        removeDragPlaceholder();
        createDragPlaceholder();

        if (targetRow) {
            tbody.insertBefore(dragPlaceholder, targetRow);
        } else {
            tbody.appendChild(dragPlaceholder);
        }
    });

    document.addEventListener('mouseup', function () {
        if (!isDragging || !dragRow) return;

        const tbody = document.getElementById('habits-tbody');
        if (!tbody || !dragPlaceholder) {
            cancelMoveRow();
            return;
        }

        tbody.insertBefore(dragRow, dragPlaceholder);
        finishMoveRow();
    });

async function addHabitRow() {
  const tbody = document.getElementById('habits-tbody');
  if (!tbody) return;

  // ‚úÖ –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–≤—ã—á–∫—É —á–µ—Ä–µ–∑ API
  const habit = await createHabitAPI('', '–î–Ω–∏', 10);
  
  if (!habit) {
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏!');
    return;
  }

  // ‚úÖ –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
  const row = document.createElement('tr');
  row.className = 'habit-row';
  row.dataset.habitId = String(habit.id);

  const nameCell = document.createElement('td');
  nameCell.className = 'col-task habit-name sticky sticky-col-1';
  nameCell.textContent = habit.name;
  row.appendChild(nameCell);

  const unitCell = document.createElement('td');
  unitCell.className = 'col-unit habit-unit sticky sticky-col-2';
  unitCell.textContent = habit.unit;
  row.appendChild(unitCell);

  const planCell = document.createElement('td');
  planCell.className = 'col-plan habit-plan sticky sticky-col-3';
  planCell.textContent = habit.plan;
  row.appendChild(planCell);

  const cellClass = getCellClass(habit.unit);

  for (let day = 1; day <= 31; day++) {
    const td = document.createElement('td');
    td.className = `habit-cell ${cellClass}`;
    td.dataset.day = String(day);
    row.appendChild(td);
  }

  const resultTd = document.createElement('td');
  resultTd.className = 'col-result habit-result';
  resultTd.textContent = '0';
  row.appendChild(resultTd);

  const percentTd = document.createElement('td');
  percentTd.className = 'col-percent habit-percent';
  percentTd.innerHTML = `<div class="habit-percent-bar"><div class="habit-percent-barfill" style="width:0%"></div><span class="habit-percent-barlabel">0%</span></div>`;
  row.appendChild(percentTd);

  tbody.appendChild(row);
  updateWeekdayHeader();
  highlightTodayColumn();
  saveRowsOrder();
  
  // ‚úÖ –°—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  startEditRow(row);
}

// ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –° –û–¢–ú–ï–ù–û–ô =====
function showUndoNotification(message, onUndo, onConfirm, timeout = 5000) {
  const toast = document.createElement('div');
  toast.className = 'undo-toast';
  toast.innerHTML = `
    <div class="undo-toast-content">
      <span class="undo-toast-message">${message}</span>
      <button class="undo-toast-btn" data-action="undo">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      <div class="undo-toast-timer"></div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  const timerBar = toast.querySelector('.undo-toast-timer');
  let startTime = Date.now();
  let cancelled = false;
  
  // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞
  function updateTimer() {
    if (cancelled) return;
    
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / timeout, 1);
    timerBar.style.width = `${progress * 100}%`;
    
    if (progress < 1) {
      requestAnimationFrame(updateTimer);
    } else {
      // –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º
      toast.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => {
        toast.remove();
        if (onConfirm) onConfirm();
      }, 300);
    }
  }
  
  requestAnimationFrame(updateTimer);
  
  // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å"
  toast.querySelector('[data-action="undo"]').addEventListener('click', () => {
    cancelled = true;
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => {
      toast.remove();
      if (onUndo) onUndo();
    }, 300);
  });
}

async function clearHabitsMonth() {
  const tbody = document.getElementById('habits-tbody');
  if (!tbody) return;

  const backdrop = document.createElement('div');
  backdrop.className = 'habits-modal-backdrop';
  backdrop.innerHTML = `
    <div class="habits-modal" role="dialog" aria-modal="true">
      <h3 class="habits-modal-title">–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—è—Ü</h3>
      <p class="habits-modal-text">
        –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –∑–∞ <strong>${monthLabel(currentYear, currentMonth)}</strong>?
      </p>
      <div class="habits-modal-actions">
        <button type="button" class="habits-modal-btn habits-modal-btn--cancel" data-role="cancel">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button type="button" class="habits-modal-btn" data-role="ok">
          –û—á–∏—Å—Ç–∏—Ç—å
        </button>
      </div>
    </div>
  `;

  function closeModal() {
    document.removeEventListener('keydown', onKeyDown);
    backdrop.remove();
  }

  function onKeyDown(e) {
    if (e.key === 'Escape') closeModal();
  }

  backdrop.addEventListener('click', async function(e) {
    const role = e.target.dataset.role;
    
    if (role === 'cancel') {
      closeModal();
    } else if (role === 'ok') {
      closeModal();
      
      // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –î–ê–ù–ù–´–ï –î–õ–Ø –û–¢–ú–ï–ù–´
      const backupData = [];
      const mk = monthKey(currentYear, currentMonth);
      const [year, month] = mk.split('-').map(Number);
      const rows = tbody.querySelectorAll('.habit-row');
      
      // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      for (const row of rows) {
        const habitId = row.dataset.habitId;
        if (!habitId) continue;
        
        const cells = row.querySelectorAll('.habit-cell');
        cells.forEach(cell => {
          const day = parseInt(cell.dataset.day);
          const value = cell.textContent.trim();
          const classes = Array.from(cell.classList);
          
          if (value || classes.includes('checked') || classes.includes('habit-cell--filled')) {
            backupData.push({
              habitId,
              year,
              month,
              day,
              value,
              classes
            });
          }
        });
      }
      
      // –û—á–∏—â–∞–µ–º UI
      for (const row of rows) {
        row.querySelectorAll('.habit-cell').forEach(cell => {
          cell.textContent = '';
          cell.classList.remove('checked', 'habit-cell--running', 'habit-cell--filled');
        });
        updateRowResult(row);
      }
      
      // ‚úÖ –ü–û–ö–ê–ó–´–í–ê–ï–ú –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –° –û–¢–ú–ï–ù–û–ô
      showUndoNotification(
        `–ú–µ—Å—è—Ü –æ—á–∏—â–µ–Ω. –û—Ç–º–µ–Ω–∏—Ç—å?`,
        async () => {
          // –§–£–ù–ö–¶–ò–Ø –û–¢–ú–ï–ù–´ - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          for (const item of backupData) {
            const row = tbody.querySelector(`[data-habit-id="${item.habitId}"]`);
            if (!row) continue;
            
            const cell = row.querySelector(`[data-day="${item.day}"]`);
            if (!cell) continue;
            
            cell.textContent = item.value;
            item.classes.forEach(cls => {
              if (cls.startsWith('habit-cell')) {
                cell.classList.add(cls);
              }
            });
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          rows.forEach(row => updateRowResult(row));
          showNotification('–ú–µ—Å—è—Ü –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!', 'success');
        },
        async () => {
          // –§–£–ù–ö–¶–ò–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø - —É–¥–∞–ª—è–µ–º –∏–∑ –ë–î
          showNotification('–£–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...', 'info');
          
          let deletedCount = 0;
          let errorCount = 0;
          
          for (const item of backupData) {
            const success = await deleteHabitRecord(item.habitId, item.year, item.month, item.day);
            if (success) deletedCount++;
            else errorCount++;
          }
          
          console.log(`–£–¥–∞–ª–µ–Ω–æ: ${deletedCount}, –û—à–∏–±–æ–∫: ${errorCount}`);
          
          if (errorCount > 0) {
            showNotification(`–£–¥–∞–ª–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏: ${errorCount}`, 'error');
          } else {
            showNotification('–ú–µ—Å—è—Ü —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!', 'success');
          }
        }
      );
    }
  });

  document.addEventListener('keydown', onKeyDown);
  document.body.appendChild(backdrop);
}





    document.addEventListener('click', function (e) {
        const addBtn = e.target.closest('#habits-add-btn');
        if (addBtn) {
            e.preventDefault();
            addHabitRow();
            return;
        }

       const clearBtn = e.target.closest('.habits-btn.habits-btn--danger');
        if (clearBtn) {
            e.preventDefault();
            clearHabitsMonth();
            return;
        }

        const newMonthBtn = e.target.closest('#habits-new-month-btn');
        if (newMonthBtn) {
            e.preventDefault();
            createNextMonthFromCurrent();
            return;
        }
    });

    function createNextMonthFromCurrent() {
        const keys = getStoredMonthKeys();
        let year = currentYear;
        let month = currentMonth;

        if (keys.length > 0) {
            const lastMk = keys[keys.length - 1];
            const [y, m] = lastMk.split('-').map(Number);
            year = y;
            month = m;
        }

        month += 1;
        if (month > 12) {
            month = 1;
            year += 1;
        }

        currentYear = year;
        currentMonth = month;

        createHabitsFromTemplate();
        applyRowsOrder();
        loadAllCellsState();
        highlightTodayColumn();
        updateWeekdayHeader();
        initMonthSelect();
    }

    // ===== –®–ê–ü–ö–ê –¢–ê–ë–õ–ò–¶–´ =====
    function updateWeekdayHeader() {
        const thead = document.querySelector('#habits-table thead');
        if (!thead) return;

        const mk = monthKey(currentYear, currentMonth);
        const [y, m] = mk.split('-').map(Number);
        const year = y;
        const monthIndex = m - 1;

        for (let day = 1; day <= 31; day++) {
            const date = new Date(year, monthIndex, day);

            const topTh = thead.querySelector('th.col-day[data-day="' + day + '"]');
            const bottomTh = thead.querySelector('th.col-day-week[data-day="' + day + '"]');

            if (date.getMonth() !== monthIndex) {
                if (topTh) {
                    topTh.textContent = day.toString();
                    topTh.classList.remove('col-day-weekend', 'col-day-disabled', 'col-day-holiday');
                }
                if (bottomTh) {
                    bottomTh.textContent = '';
                    bottomTh.classList.remove('col-day-weekend', 'col-day-disabled', 'col-day-holiday');
                }

                const tbody = document.getElementById('habits-tbody');
                if (tbody) {
                    tbody.querySelectorAll('td[data-day="' + day + '"]').forEach(td => {
                        td.classList.remove('habit-col-weekend', 'habit-col-holiday');
                    });
                }
                continue;
            }

            const weekday = date.getDay();
            const weekdayIndex = (weekday + 6) % 7;
            const name = weekdayNamesShort[weekdayIndex];

            const isWeekend = (weekdayIndex === 5 || weekdayIndex === 6);
            const isHoliday = isProductionHoliday(date);

            if (topTh) {
                topTh.textContent = day.toString();
                topTh.classList.toggle('col-day-weekend', isWeekend || isHoliday);
                topTh.classList.toggle('col-day-holiday', isHoliday);
                topTh.classList.remove('col-day-disabled');
            }
            if (bottomTh) {
                bottomTh.textContent = name;
                bottomTh.classList.toggle('col-day-weekend', isWeekend || isHoliday);
                bottomTh.classList.toggle('col-day-holiday', isHoliday);
                bottomTh.classList.remove('col-day-disabled');
            }

            const tbody = document.getElementById('habits-tbody');
            if (tbody) {
                tbody.querySelectorAll('td[data-day="' + day + '"]').forEach(td => {
                    td.classList.toggle('habit-col-weekend', isWeekend || isHoliday);
                    td.classList.toggle('habit-col-holiday', isHoliday);
                });
            }
        }
    }

    function highlightTodayColumn() {
        const table = document.getElementById('habits-table');
        const wrapper = table?.closest('.table-wrapper--scroll');
        if (!table || !wrapper) return;

        const today = new Date();
        const day = today.getDate();
        if (day < 1 || day > 31) return;

        table.querySelectorAll('.col-day-today').forEach(th => th.classList.remove('col-day-today'));
        table.querySelectorAll('.habit-cell--today').forEach(td => td.classList.remove('habit-cell--today'));

        const dayHeaders = table.querySelectorAll('thead .col-day');
        const targetHeader = dayHeaders[day - 1];
        if (!targetHeader) return;

        targetHeader.classList.add('col-day-today');

        const tbody = document.getElementById('habits-tbody');
        if (tbody) {
            tbody.querySelectorAll('.habit-cell[data-day="' + day + '"]').forEach(td => {
                td.classList.add('habit-cell--today');
            });
        }

        const headerRect = targetHeader.getBoundingClientRect();
        const tableRect = table.getBoundingClientRect();

        const headerOffsetLeft = headerRect.left - tableRect.left;
        const headerCenter = headerOffsetLeft + headerRect.width / 2;

        const visibleWidth = wrapper.clientWidth;
        const scrollTarget = headerCenter - visibleWidth / 2;

        wrapper.scrollLeft = Math.max(0, scrollTarget);
    }

    function deleteCurrentMonthData() {
        const mk = monthKey(currentYear, currentMonth);
        if (!mk) return;

        if (!confirm('–£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ—Å—è—Ü–∞ ' + monthLabel(currentYear, currentMonth) + '?')) {
            return;
        }

        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (!k) continue;
            if (k.startsWith('habits:' + mk + ':') || k === 'habits:order:' + mk) {
                keysToRemove.push(k);
            }
        }
        keysToRemove.forEach(k => {
            try { localStorage.removeItem(k); } catch (e) {}
        });

        createHabitsFromTemplate();
        applyRowsOrder();
        loadAllCellsState();
        highlightTodayColumn();
        updateWeekdayHeader();
        initMonthSelect();
    }

    const deleteMonthBtn = document.getElementById('habits-delete-month-btn');
    if (deleteMonthBtn) {
        deleteMonthBtn.addEventListener('click', function () {
            deleteCurrentMonthData();
        });
    }

    function initTableWheelScroll() {
        const wrapper = document.querySelector('.table-wrapper--scroll');
        if (!wrapper) return;

        wrapper.addEventListener('wheel', function (e) {
            if (wrapper.scrollWidth > wrapper.clientWidth) {
                wrapper.scrollLeft += e.deltaY;
                e.preventDefault();
            }
        }, { passive: false });
    }

    // ===== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –¢–ï–ú–ê =====
    
    // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã (—à–µ—Å—Ç–µ—Ä–µ–Ω–∫–∞) - 5 –¢–ï–ú
    const THEMES_LIST = ['theme-storm', 'theme-ice', 'theme-blood', 'theme-toxic', 'theme-glitch'];
    let currentThemeIndex = 0;


// ==================== API –î–õ–Ø –ü–†–ò–í–´–ß–ï–ö ====================



// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function getAuthToken() {
  return localStorage.getItem('app-auth-token');
}

// –ü–æ–ª—É—á–∏—Ç—å headers —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
function getAuthHeaders() {
  const token = getAuthToken();
  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  };
}

async function loadHabitsFromAPI() {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
  if (!isLoggedIn || !currentUser || !currentUser.token) {
    console.warn('User not logged in, cannot load habits');
    return [];
  }
  
  try {
    const response = await fetch(`${API_URL}/api/habits`, {
      headers: getAuthHeaders()
    });
    
    if (response.status === 403 || response.status === 401) {
      console.error('Auth token invalid or expired');
      // –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
      localStorage.removeItem('app-auth-token');
      localStorage.removeItem('app-user-email');
      isLoggedIn = false;
      currentUser = null;
      alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
      location.reload();
      return [];
    }
    
    if (!response.ok) {
      console.error('Failed to load habits:', response.status);
      return [];
    }
    return await response.json();
  } catch (err) {
    console.error('Error loading habits:', err);
    return [];
  }
}


// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø–∏—Å–∏ –ø—Ä–∏–≤—ã—á–µ–∫ –∑–∞ –º–µ—Å—è—Ü
async function loadHabitRecordsForMonth(year, month) {
  if (!isLoggedIn || !currentUser || !currentUser.token) {
    console.warn('User not logged in, cannot load records');
    return [];
  }
  
  try {
    const response = await fetch(`${API_URL}/api/habits/records/${year}/${month}`, {
      headers: getAuthHeaders()
    });
    
    if (response.status === 403 || response.status === 401) {
      console.error('Auth token invalid or expired');
      return [];
    }
    
    if (!response.ok) {
      console.error('Failed to load habit records:', response.status);
      return [];
    }
    return await response.json();
  } catch (err) {
    console.error('Error loading habit records:', err);
    return [];
  }
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –ø—Ä–∏–≤—ã—á–∫–∏
async function saveHabitRecord(habitId, year, month, day, value) {
  try {
    const response = await fetch(`${API_URL}/api/habits/records`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        habit_id: habitId,
        year: year,
        month: month,
        day: day,
        value: value
      })
    });
    
    if (!response.ok) {
      console.error('Failed to save habit record:', response.status);
      return false;
    }
    
    return true;
  } catch (err) {
    console.error('Error saving habit record:', err);
    return false;
  }
}

// ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ—Ç–∫–∏
async function deleteHabitRecord(habitId, year, month, day) {
  const token = localStorage.getItem('app-auth-token');
  if (!token) {
    console.error('No auth token');
    return false;
  }

  try {
    // ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–ú URL –° –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò
    const url = `${API_URL}/api/habits/records/${habitId}/${year}/${month}/${day}`;
    console.log(`üóëÔ∏è Deleting: ${url}`);
    
    const response = await fetch(url, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    console.log(`Response status: ${response.status}`);

    if (!response.ok) {
      const data = await response.json().catch(() => ({}));
      console.error(`‚ùå Server error for day ${day}:`, data);
      return false;
    }

    const data = await response.json();
    console.log(`‚úÖ Deleted day ${day}:`, data);
    
    return data.success === true;
  } catch (err) {
    console.error(`‚ùå Network error for day ${day}:`, err);
    return false;
  }
}


// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É
async function createHabitAPI(name, unit, plan) {
  try {
    const response = await fetch(`${API_URL}/api/habits`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ name, unit, plan })
    });
    
    if (!response.ok) {
      console.error('Failed to create habit:', response.status);
      return null;
    }
    
    return await response.json();
  } catch (err) {
    console.error('Error creating habit:', err);
    return null;
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É
async function updateHabitAPI(habitId, name, unit, plan) {
  try {
    const response = await fetch(`${API_URL}/api/habits/${habitId}`, {
      method: 'PUT',
      headers: getAuthHeaders(),
      body: JSON.stringify({ name, unit, plan })
    });
    
    if (!response.ok) {
      console.error('Failed to update habit:', response.status);
      return false;
    }
    
    return true;
  } catch (err) {
    console.error('Error updating habit:', err);
    return false;
  }
}

// ==================== –ü–†–û–ì–†–ï–°–°-–ë–ê–†–´ (–ñ–ò–ó–ù–ï–ù–ù–û–ï –í–†–ï–ú–Ø) ====================

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏ —Ä–∞—Å—á—ë—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
async function loadUserProfileAndProgress() {
  const token = localStorage.getItem('app-auth-token');
  if (!token) {
    updateLifeProgress(null);
    return;
  }

  try {
    const response = await fetch('http://85.198.96.149:5000/api/user/profile', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (!response.ok) {
      updateLifeProgress(null);
      return;
    }

    const profile = await response.json();
    updateLifeProgress(profile.birthdate);
  } catch (err) {
    console.error('Error loading profile:', err);
    updateLifeProgress(null);
  }
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateLifeProgress(birthdate) {
  const lifePercentEl = document.getElementById('lifePercent');
  const lifeProgressBar = document.getElementById('lifeProgressBar');
  const lifeProgressText = document.getElementById('lifeProgressText');
  const lifeDetails = document.getElementById('lifeDetails');

  const yearDaysEl = document.getElementById('yearDays');
  const yearProgressBar = document.getElementById('yearProgressBar');
  const yearProgressText = document.getElementById('yearProgressText');
  const yearDetails = document.getElementById('yearDetails');

  if (!birthdate) {
    if (lifePercentEl) lifePercentEl.textContent = '0%';
    if (lifeProgressBar) lifeProgressBar.style.width = '0%';
    if (lifeProgressText) lifeProgressText.textContent = '0%';
    if (lifeDetails) lifeDetails.textContent = '0 –ª–µ—Ç, 100% –æ—Å—Ç–∞–ª–æ—Å—å';

    if (yearDaysEl) yearDaysEl.textContent = '0';
    if (yearProgressBar) yearProgressBar.style.width = '0%';
    if (yearProgressText) yearProgressText.textContent = '0%';
    if (yearDetails) yearDetails.textContent = '0 –¥–Ω–µ–π –ø—Ä–æ–∂–∏—Ç–æ, 0 –¥–æ –î–†';
    return;
  }

  const today = new Date();
  const birth = new Date(birthdate);

  // === –†–ê–°–ß–Å–¢ –ü–†–û–ñ–ò–¢–û–ô –ñ–ò–ó–ù–ò (–æ—Ç 64 –ª–µ—Ç) ===
  const lifeExpectancy = 64;
  const ageMs = today - birth;
  const ageYears = ageMs / (1000 * 60 * 60 * 24 * 365.25);
  const lifePercent = Math.min(100, Math.round((ageYears / lifeExpectancy) * 100));
  const remainingYears = Math.max(0, Math.round(lifeExpectancy - ageYears));

  if (lifePercentEl) lifePercentEl.textContent = `${lifePercent}%`;
  if (lifeProgressBar) lifeProgressBar.style.width = `${lifePercent}%`;
  if (lifeProgressText) lifeProgressText.textContent = `${lifePercent}%`;
  if (lifeDetails) lifeDetails.textContent = `${Math.floor(ageYears)} –ª–µ—Ç –ø—Ä–æ–∂–∏—Ç–æ, ${remainingYears} –ª–µ—Ç –æ—Å—Ç–∞–ª–æ—Å—å`;

  // === –†–ê–°–ß–Å–¢ –õ–ò–ß–ù–û–ì–û –ì–û–î–ê ===
  const birthMonth = birth.getMonth();
  const birthDay = birth.getDate();

  let yearStart = new Date(today.getFullYear(), birthMonth, birthDay);
  if (today < yearStart) {
    yearStart = new Date(today.getFullYear() - 1, birthMonth, birthDay);
  }

  const yearEnd = new Date(yearStart.getFullYear() + 1, birthMonth, birthDay - 1);
  const daysInYear = Math.round((yearEnd - yearStart) / (1000 * 60 * 60 * 24)) + 1;
  const daysPassed = Math.round((today - yearStart) / (1000 * 60 * 60 * 24));
  const daysLeft = daysInYear - daysPassed;
  const yearPercent = Math.min(100, Math.round((daysPassed / daysInYear) * 100));

  if (yearDaysEl) yearDaysEl.textContent = daysPassed;
  if (yearProgressBar) yearProgressBar.style.width = `${yearPercent}%`;
  if (yearProgressText) yearProgressText.textContent = `${yearPercent}%`;
  if (yearDetails) yearDetails.textContent = `${daysPassed} –¥–Ω–µ–π –ø—Ä–æ–∂–∏—Ç–æ, ${daysLeft} –¥–Ω–µ–π –¥–æ –î–†`;
}

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function loadTheme() {
        try {
            const savedIndex = localStorage.getItem('app-theme-index');
            if (savedIndex !== null) {
                currentThemeIndex = parseInt(savedIndex, 10);
                if (currentThemeIndex < 0 || currentThemeIndex >= THEMES_LIST.length) {
                    currentThemeIndex = 0;
                }
            }
            
            const body = document.body;
            THEMES_LIST.forEach(theme => body.classList.remove(theme));
            body.classList.add(THEMES_LIST[currentThemeIndex]);
        } catch (e) {}
    }

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
document.addEventListener('DOMContentLoaded', async function() {
  loadUserProfileAndProgress();
  loadTheme();
  
  // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏–≤—ã—á–µ–∫
  await createHabitsFromTemplate();
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫
  applyRowsOrder();
  
  // –ó–ê–¢–ï–ú –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —è—á–µ–µ–∫
  await loadAllCellsState();
  
  // –û—Å—Ç–∞–ª—å–Ω–æ–µ
  initMonthSelect();
  highlightTodayColumn();
  updateWeekdayHeader();
  initTableWheelScroll();
});

})();
</script>

<script>
// ===== ONBOARDING TOUR ===== (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
(function() {
  const TOUR_KEY = 'habits-tour-completed';
  
  const tourSteps = [
    {
      element: '.app-header__settings-btn',
      title: 'üé® –°–º–µ–Ω–∞ —Ç–µ–º—ã',
      text: '–ù–∞–∂–º–∏ –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç–æ–≤—É—é —Ç–µ–º—É. –î–æ—Å—Ç—É–ø–Ω–æ 5 —Ç–µ–º: Storm, Ice, Blood, Toxic –∏ Glitch.',
      position: 'bottom'
    },
    {
      element: '.block-life-time',
      title: '‚è≥ –ñ–∏–∑–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è',
      text: '–ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω–æ, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –ø—Ä–æ—à–ª–æ –∏ —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –≤ —ç—Ç–æ–º –≥–æ–¥—É. –í–≤–µ–¥–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –¥–ª—è —Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.',
      position: 'bottom'
    },
    {
      element: '#habits-add-btn',
      title: '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É',
      text: '–ù–∞–∂–º–∏ —Å—é–¥–∞, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–∫–Ω–∏ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ, –µ–¥–∏–Ω–∏—Ü—É –∏–ª–∏ –ø–ª–∞–Ω, —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.',
      position: 'top'
    },
    {
      element: '.habits-month-select-wrapper',
      title: 'üìÖ –í—ã–±–æ—Ä –º–µ—Å—è—Ü–∞',
      text: '–ü–µ—Ä–µ–∫–ª—é—á–∞–π—Å—è –º–µ–∂–¥—É –º–µ—Å—è—Ü–∞–º–∏. –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π –º–µ—Å—è—Ü" —Å–æ–∑–¥–∞—Å—Ç —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.',
      position: 'bottom'
    },
    {
      element: '.table-wrapper',
      title: 'üìä –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–≤—ã—á–µ–∫',
      text: '–õ–ö–ú ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ. –ü–ö–ú ‚Äî —É–±–∞–≤–∏—Ç—å. –î–ª—è —Ç–∞–π–º–µ—Ä–æ–≤: –∫–ª–∏–∫ —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø, –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –º–∏–Ω—É—Å —á–∞—Å.',
      position: 'top'
    },
    {
      element: '.habits-help-tooltip',
      title: '‚ùì –ü–æ–¥—Å–∫–∞–∑–∫–∏',
      text: '–ù–∞–≤–µ–¥–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞ —ç—Ç–æ—Ç –∑–Ω–∞—á–æ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º —Ç—Ä–µ–∫–µ—Ä–∞.',
      position: 'left'
    }
  ];

  let currentStep = 0;
  let overlay, spotlight, tooltip, titleEl, textEl, nextBtn, prevBtn, skipBtn, currentStepEl;

  function initTour() {
    overlay = document.getElementById('onboarding-overlay');
    spotlight = document.getElementById('onboarding-spotlight');
    tooltip = document.getElementById('onboarding-tooltip');
    titleEl = document.getElementById('tour-title');
    textEl = document.getElementById('tour-text');
    nextBtn = document.getElementById('tour-next');
    prevBtn = document.getElementById('tour-prev');
    skipBtn = document.getElementById('tour-skip');
    currentStepEl = document.getElementById('tour-current');
    
    if (!overlay) {
      console.error('‚ùå Onboarding overlay not found!');
      return false;
    }
    
    document.getElementById('tour-total').textContent = tourSteps.length;

    nextBtn.addEventListener('click', nextStep);
    prevBtn.addEventListener('click', prevStep);
    skipBtn.addEventListener('click', endTour);

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.style.display === 'block') {
        endTour();
      }
    });
    
    return true;
  }

  function startTour() {
    const testElement = document.querySelector('.app-header__settings-btn');
    if (!testElement) {
      console.warn('‚ö†Ô∏è Elements not ready, retrying...');
      setTimeout(startTour, 500);
      return;
    }
    
    currentStep = 0;
    overlay.style.display = 'block';
    
    // ‚úÖ –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —à–∞–≥–æ–º
    setTimeout(() => showStep(currentStep), 100);
  }

  function showStep(stepIndex) {
    const step = tourSteps[stepIndex];
    const targetEl = document.querySelector(step.element);
    
    if (!targetEl) {
      console.warn('‚ö†Ô∏è Element not found:', step.element);
      if (stepIndex < tourSteps.length - 1) {
        setTimeout(() => showStep(stepIndex + 1), 100);
      } else {
        endTour();
      }
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    titleEl.textContent = step.title;
    textEl.textContent = step.text;
    currentStepEl.textContent = stepIndex + 1;

    // –ö–Ω–æ–ø–∫–∏
    prevBtn.style.display = stepIndex > 0 ? 'inline-block' : 'none';
    nextBtn.textContent = stepIndex === tourSteps.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å' : '–î–∞–ª–µ–µ';

    // ‚úÖ –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä–æ–ª–ª, –ø–æ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
    
    // ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
    setTimeout(() => {
      updateSpotlightPosition(targetEl, step.position);
    }, 400);  // 400–º—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è smooth scroll
  }

  function updateSpotlightPosition(targetEl, position) {
    // ‚úÖ –û–î–ò–ù –í–´–ó–û–í getBoundingClientRect() - —Ö—Ä–∞–Ω–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const rect = targetEl.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    // ‚úÖ –ü–æ–∑–∏—Ü–∏—è spotlight –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ù–ï viewport!)
    const spotlightTop = rect.top + scrollTop - 8;
    const spotlightLeft = rect.left + scrollLeft - 8;
    const spotlightWidth = rect.width + 16;
    const spotlightHeight = rect.height + 16;
    
    spotlight.style.top = `${spotlightTop}px`;
    spotlight.style.left = `${spotlightLeft}px`;
    spotlight.style.width = `${spotlightWidth}px`;
    spotlight.style.height = `${spotlightHeight}px`;

    // ‚úÖ Tooltip –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ spotlight
    setTimeout(() => {
      positionTooltip(rect, position, scrollTop, scrollLeft);
    }, 50);
  }

  function positionTooltip(rect, position, scrollTop, scrollLeft) {
    const tooltipRect = tooltip.getBoundingClientRect();
    const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
    const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
    let top, left;

    switch (position) {
      case 'bottom':
        top = rect.bottom + scrollTop + 20;
        left = rect.left + scrollLeft + rect.width / 2 - tooltipRect.width / 2;
        break;
      case 'top':
        top = rect.top + scrollTop - tooltipRect.height - 20;
        left = rect.left + scrollLeft + rect.width / 2 - tooltipRect.width / 2;
        break;
      case 'left':
        top = rect.top + scrollTop + rect.height / 2 - tooltipRect.height / 2;
        left = rect.left + scrollLeft - tooltipRect.width - 20;
        break;
      case 'right':
        top = rect.top + scrollTop + rect.height / 2 - tooltipRect.height / 2;
        left = rect.right + scrollLeft + 20;
        break;
      default:
        top = rect.bottom + scrollTop + 20;
        left = rect.left + scrollLeft;
    }

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è viewport
    const margin = 20;
    
    if (left < margin) left = margin;
    if (left + tooltipRect.width > viewportWidth - margin) {
      left = viewportWidth - tooltipRect.width - margin;
    }
    if (top < scrollTop + margin) top = rect.bottom + scrollTop + 20;

    tooltip.style.top = `${Math.max(margin, top)}px`;
    tooltip.style.left = `${Math.max(margin, left)}px`;
  }

  function nextStep() {
    if (currentStep < tourSteps.length - 1) {
      currentStep++;
      showStep(currentStep);
    } else {
      endTour();
    }
  }

  function prevStep() {
    if (currentStep > 0) {
      currentStep--;
      showStep(currentStep);
    }
  }

  function endTour() {
    overlay.style.display = 'none';
    localStorage.setItem(TOUR_KEY, 'true');
  }

  window.restartTour = function() {
    localStorage.removeItem(TOUR_KEY);
    if (initTour()) {
      startTour();
    }
  };

  // ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DOM
  function attemptStart() {
    const hasSeenTour = localStorage.getItem(TOUR_KEY);
    if (!hasSeenTour) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
      const requiredElements = [
        '.app-header__settings-btn',
        '#habits-add-btn',
        '.table-wrapper'
      ];
      
      const allReady = requiredElements.every(sel => document.querySelector(sel));
      
      if (allReady) {
        if (initTour()) {
          startTour();
        }
      } else {
        console.warn('‚ö†Ô∏è Some elements not ready, retrying...');
        setTimeout(attemptStart, 500);
      }
    }
  }

  // ‚úÖ –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(attemptStart, 1500);  // 1.5 —Å–µ–∫ –ø–æ—Å–ª–µ DOMContentLoaded
    });
  } else {
    setTimeout(attemptStart, 1500);
  }
})();
</script>
<!-- ===== ONBOARDING TOUR HTML ===== -->
<div id="onboarding-overlay" class="onboarding-overlay" style="display: none;">
  <div class="onboarding-backdrop"></div>
  <div id="onboarding-spotlight" class="onboarding-spotlight"></div>
  <div id="onboarding-tooltip" class="onboarding-tooltip">
    <div class="onboarding-tooltip__header">
      <span class="onboarding-tooltip__step">–®–∞–≥ <span id="tour-current">1</span> –∏–∑ <span id="tour-total">6</span></span>
      <button class="onboarding-tooltip__close" id="tour-skip">‚úï</button>
    </div>
    <h3 class="onboarding-tooltip__title" id="tour-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
    <p class="onboarding-tooltip__text" id="tour-text">–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏</p>
    <div class="onboarding-tooltip__actions">
      <button class="onboarding-tooltip__btn onboarding-tooltip__btn--secondary" id="tour-prev" style="display: none;">–ù–∞–∑–∞–¥</button>
      <button class="onboarding-tooltip__btn onboarding-tooltip__btn--primary" id="tour-next">–î–∞–ª–µ–µ</button>
    </div>
  </div>
</div>

</body>
</html>
